---
- hosts: all
  gather_facts: false
  tasks:
    - name: block with rescue only
      block:
        - name: task 1
          command: /bin/false
      rescue:
        - name: rescue file
          file:
            path: /tmp/spage/rescue_file.txt
            state: touch

    - name: rescue file exists
      stat:
        path: /tmp/spage/rescue_file.txt
      register: rescue_file_stat
      after: block with rescue only

    - name: assert rescue file exists
      assert:
        that:
          - rescue_file_stat.stat.exists

    - name: block with always only
      block:
        - name: task 1
          command: /bin/true
        - name: task 2
          command: /bin/true
      always:
        - name: always task
          command: /bin/true

    - name: outer block
      block:
        - name: outer task 1
          command: /bin/true
        - name: inner block
          block:
            - name: create file
              file:
                path: /tmp/spage/nested_file.txt
                state: touch

    - name: assert nested file exists
      stat:
        path: /tmp/spage/nested_file.txt
      register: nested_file_stat
      after: outer block

    - name: assert nested file exists
      assert:
        that:
          - nested_file_stat.stat.exists

    - name: series of tasks
      block:
        - name: task 1
          command: /bin/true
        - name: task 2
          command: /bin/true
      rescue:
        - name: task 3 (no errors so does not run)
          command: /bin/false
      always:
        - name: task 4
          file:
            path: /tmp/spage/block_file.txt
            state: touch
      when: true

    - name: always file exists
      stat:
        path: /tmp/spage/block_file.txt
      register: always_file_stat
      after: series of tasks

    - name: assert always file exists
      assert:
        that:
          - always_file_stat.stat.exists

    - name: block does not run
      block:
        - name: task 1
          command: /bin/true
        - name: task 2 (no errors so does not run)
          command: /bin/false
      always:
        - name: task 3
          file:
            path: /tmp/spage/does_not_exist.txt
            state: touch
      when: false

    - name: parent block with variables
      block:
        - name: task 1
          assert:
            that:
              - variable_1 == 1
      vars:
        variable_1: 1

    - name: assert variable doesn't exists
      assert:
        that:
          - variable_1 is not defined
      after: parent block with variables
