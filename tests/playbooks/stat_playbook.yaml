---
- name: Test Stat Module
  hosts: localhost
  tasks:
    - name: Create a temporary file for stat test
      copy:
        content: "This is a test file for the stat module."
        dest: /tmp/spage_stat_test_file.txt
        mode: '0644'

    - name: Create a symlink for stat test
      shell:
        cmd: ln -sf /tmp/spage_stat_test_file.txt /tmp/spage_stat_test_link.txt

    - name: Stat the regular file
      stat:
        path: /tmp/spage_stat_test_file.txt
        get_checksum: true
        get_mime: true
        get_attributes: true # May fail on non-Linux, but let's test
      register: stat_result_file

    - name: Stat the symlink (follow=false)
      stat:
        path: /tmp/spage_stat_test_link.txt
        follow: false
      register: stat_result_link_nofollow

    - name: Stat the symlink (follow=true)
      stat:
        path: /tmp/spage_stat_test_link.txt
        follow: true
        checksum_algorithm: md5 # Test different algo
        get_checksum: true
      register: stat_result_link_follow

    - name: Assertions for regular file stat
      assert:
        that:
          - stat_result_file.stat.exists
          - stat_result_file.stat.isreg
          - not stat_result_file.stat.isdir
          - not stat_result_file.stat.islnk
          - stat_result_file.stat.mode == '0644' # Check mode
          - stat_result_file.stat.size > 0
          - stat_result_file.stat.checksum is defined # Checksum exists (SHA1 default)
          - stat_result_file.stat.mime == 'text/plain' # Check mime type
          # - stat_result_file.stat.attributes is defined # Check attributes (might fail)

    - name: Assertions for symlink stat (nofollow)
      assert:
        that:
          - stat_result_link_nofollow.stat.exists
          - not stat_result_link_nofollow.stat.isreg
          - not stat_result_link_nofollow.stat.isdir
          - stat_result_link_nofollow.stat.islnk

    - name: Assertions for symlink stat (follow)
      assert:
        that:
          - stat_result_link_follow.stat.exists
          - stat_result_link_follow.stat.isreg # Should resolve to the file
          - not stat_result_link_follow.stat.isdir
          - not stat_result_link_follow.stat.islnk
          - stat_result_link_follow.stat.mode == '0644'
          - stat_result_link_follow.stat.checksum is defined # Checksum exists (MD5)
          - stat_result_link_follow.stat.checksum != stat_result_file.stat.checksum # SHA1 vs MD5 